pipeline {
    agent any
    triggers { pollSCM('* * * * *') }
    stages {
        stage('build') {
            steps {
                sh '''
                    docker rmi -f $(docker images |grep -v nginx |awk 'NR>1 {print {$3}'|uniq) ||true
                    cd website/Docker/
                    sudo docker build -t lopihara/dynamic-page:latest -t lopihara/dynamic-page:2.${BUILD_NUMBER} .
                    docker login -u lopihara -p $DKR_TOKEN
                    docker push lopihara/dynamic-page:latest
                    docker push lopihara/dynamic-page:2.${BUILD_NUMBER}
                '''
            }
        }
        stage('after_build') {
            steps {
                sh '''
                    ssh -i /home/agent/.ssh/web.pk web@10.70.55.157 docker stop dynamic-page ||true
                    ssh -i /home/agent/.ssh/web.pk web@10.70.55.157 docker pull lopihara/dynamic-page:latest
                    ssh -i /home/agent/.ssh/web.pk web@10.70.55.157 docker run -d -it --rm --name dynamic-page -p 80:80 lopihara/dynamic-page:latest
                '''
            }
        }
    }
}